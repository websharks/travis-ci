# ----------------------------------------------------------------------------------------------------------------------

# General (main context).

pid %%HOME%%/ws/tmp/nginx.pid;
user %%USER%% %%GROUP%%;
worker_processes auto;

events {
  worker_connections 768;
  # See: <http://jas.xyz/1mgiQlM>
}

# ----------------------------------------------------------------------------------------------------------------------

# Web server (http context).

http {
  # Performance.

  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;

  # DNS resolution.

  resolver_timeout 5s;
  resolver 8.8.8.8 8.8.4.4;

  # Buffer tweaks.

  client_max_body_size 10m;
  client_body_buffer_size 10k;
  client_header_buffer_size 1k;
  large_client_header_buffers 4 8k;

  # Reasonable timeouts.

  client_body_timeout 10s;
  client_header_timeout 10s;
  keepalive_timeout 15s 15s;
  send_timeout 10s;

  # Open file cache.

  open_file_cache max=5000 inactive=30s;
  open_file_cache_valid 30s;
  open_file_cache_min_uses 2;
  open_file_cache_errors on;

  # Log file settings.

  error_log %%HOME%%/ws/logs/nginx/error.log;
  access_log %%HOME%%/ws/logs/nginx/access.log;

  # Directory indexing.

  index index.html index.php;

  # Configure several MIME types.

  types {
    text/xml xml;
    text/plain txt md;
    text/html html htm;

    application/rss+xml rss;
    application/atom+xml atom;
    application/xhtml+xml xhtml;

    text/css css;
    application/json json;
    application/x-javascript js;

    image/gif gif;
    image/png png;
    image/x-icon ico;
    image/x-ms-bmp bmp;
    image/tiff tif tiff;
    image/svg+xml svg svgz;
    application/postscript ai eps;
    image/jpeg jpg jpeg jpe;

    audio/mpeg mp3;
    audio/ogg ogg;
    audio/midi mid midi;

    video/mp4 mp4;
    video/x-flv flv;
    video/webm webm;
    video/x-ms-wmv wmv;
    video/x-msvideo avi;
    video/quicktime mov;
    video/mpeg mpeg mpg;
    application/x-shockwave-flash swf;

    application/font-otf otf;
    application/font-ttf ttf;
    application/font-woff woff woff2;
    application/vnd.ms-fontobject eot;

    application/x-x509-ca-cert crt pem;

    application/zip zip;
    application/gzip gz;
    application/x-gtar tgz;
    application/x-httpd-php phar;
    application/x-7z-compressed 7z;
    application/x-rar-compressed rar;
    application/java-archive jar war ear;

    application/x-redhat-package-manager rpm;
    application/octet-stream deb dmg exe msi dll;

    application/pdf pdf;
    application/rtf rtf;
    application/msword doc;
    application/vnd.ms-excel xls;
    application/vnd.ms-powerpoint ppt;
    application/vnd.openxmlformats-officedocument.spreadsheetml.sheet xlsx;
    application/vnd.openxmlformats-officedocument.wordprocessingml.document docx;
    application/vnd.openxmlformats-officedocument.presentationml.presentation pptx;
  }
  default_type application/octet-stream;

  # Prevent MIME sniffing. See: <http://jas.xyz/1kVvF41>

  add_header x-content-type-options nosniff always;

  # GZIP compresion for compressable MIME types.

  gzip on; gzip_vary on; gzip_comp_level 6; # Enable GZIP.

  gzip_types text/plain text/xml # text/html is already in Nginx core.
    image/svg+xml application/rss+xml application/atom+xml application/xhtml+xml
    text/css application/json application/x-javascript
    application/font-otf application/font-ttf;

  # Map access-control-allow-origin header.

  map $uri $access_control_allow_origin {
    default '';
    ~*\.(?:otf|ttf|woff|woff2|eot)$ '*';
  }
  add_header access-control-allow-origin $access_control_allow_origin;

  # Client-side cache.

  if_modified_since exact;
  etag on; # See: <http://jas.xyz/1MzvnWz>

  map $uri $_expires {
    default 5d;
    ~*[^/]\.php(?:/|$) off;
  }
  expires $_expires;

# ----------------------------------------------------------------------------------------------------------------------

  # HTTP (server context).

  server {
    # Any.

    server_name _;

    # Doc root.

    root %%HOME%%/ws/www;

    # HTTP only.

    listen 8080 default_server;
    listen [::]:8080 default_server;

    # Security considerations.

    if ($uri ~* /\.) {
      return 403;
    }
    if ($uri ~* ~(?:/|$)) {
      return 403;
    }
    if ($uri ~* /xmlrpc\.php(?:/|$)) {
      return 403;
    }
    if ($uri ~* /phpinfo\.php(?:/|$)) {
      return 403;
    }
    if ($uri ~* \.(?:bak|copy|log|old|tmp)$) {
      return 403;
    }
    if ($uri ~* /(?:uploads|files)/.*?\.php(?:/|$)) {
      return 403;
    }
    if ($uri ~* /(?:includes|vendor)/.*?\.php(?:/|$)) {
      return 403;
    }
    if ($uri ~* /(?:mu\-plugins)/.*?\.php(?:/|$)) {
      return 403;
    }
    if ($uri ~* /(?:wp\-)?config(?:\.inc)?\.php(?:/|$)) {
      return 403;
    }

# ----------------------------------------------------------------------------------------------------------------------

    # Locations (same server context).

    ## Robots/favicon.

    location = /robots.txt {
      access_log off;
      log_not_found off;
    }
    location = /favicon.ico {
      access_log off;
      log_not_found off;
    }
    ## WordPress adminisrative area.

    location ^~ /wp-admin/ {
      client_max_body_size 200m; # PHP max.
      include %%HOME%%/ws/repos/travis-ci/src/nginx/snippets/php-ext-location.conf;
      include %%HOME%%/ws/repos/travis-ci/src/nginx/snippets/static-exts-location.conf;
      try_files $uri $uri/ =404; # No `/index.php` default here.
    }
    ## Default file handling w/ PHP fallback.

    include %%HOME%%/ws/repos/travis-ci/src/nginx/snippets/php-ext-location.conf;
    include %%HOME%%/ws/repos/travis-ci/src/nginx/snippets/static-exts-location.conf;
    include %%HOME%%/ws/repos/travis-ci/src/nginx/snippets/default-location-php-fallback.conf;
  }
}
